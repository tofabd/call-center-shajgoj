<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/pusher-js@8/dist/web/pusher.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/laravel-echo@2/dist/echo.js"></script>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    <div id="status">Connecting...</div>
    <div id="messages"></div>

    <script>
        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');
        
        function addMessage(message) {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            messagesDiv.appendChild(div);
        }

        try {
            // Initialize Echo with Reverb
            window.Pusher = Pusher;
            
            const echo = new Echo({
                broadcaster: 'reverb',
                key: 'otp1qepgz0gsohqgsypv',
                wsHost: '154.89.7.108',
                wsPort: 8080,
                forceTLS: false,
                enabledTransports: ['ws']
            });

            addMessage('Echo initialized');
            statusDiv.textContent = 'Echo initialized, attempting to connect...';

            // Test extension channel
            echo.channel('extensions')
                .listen('.extension.status.updated', (data) => {
                    addMessage('Extension update received: ' + JSON.stringify(data));
                    statusDiv.textContent = 'Connected and receiving events!';
                });

            // Test call channel
            echo.channel('call-console')
                .listen('.call-updated', (data) => {
                    addMessage('Call update received: ' + JSON.stringify(data));
                    statusDiv.textContent = 'Connected and receiving events!';
                });

            // Connection status
            if (echo.connector && echo.connector.pusher) {
                echo.connector.pusher.connection.bind('connected', () => {
                    addMessage('WebSocket connected successfully!');
                    statusDiv.textContent = 'Connected - listening for events...';
                });

                echo.connector.pusher.connection.bind('error', (err) => {
                    addMessage('Connection error: ' + JSON.stringify(err));
                    statusDiv.textContent = 'Connection error - see messages below';
                });

                echo.connector.pusher.connection.bind('disconnected', () => {
                    addMessage('WebSocket disconnected');
                    statusDiv.textContent = 'Disconnected';
                });
            }

            addMessage('Channels subscribed, waiting for events...');

        } catch (error) {
            addMessage('Error: ' + error.message);
            statusDiv.textContent = 'Failed to initialize';
        }
    </script>
</body>
</html>